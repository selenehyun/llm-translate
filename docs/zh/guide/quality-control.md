# 质量控制

llm-translate 使用 Self-Refine 算法确保翻译质量符合您的要求。

## Self-Refine 工作原理

```
┌─────────────────┐
│ Initial Translate│
└────────┬────────┘
         ▼
┌─────────────────┐
│ Evaluate Quality │◀──────────────┐
└────────┬────────┘               │
         ▼                        │
    Score >= Threshold?           │
         │                        │
    No   │   Yes                  │
         │    │                   │
         ▼    ▼                   │
┌─────────┐ ┌──────┐              │
│ Reflect │ │ Done │              │
└────┬────┘ └──────┘              │
     ▼                            │
┌─────────────────┐               │
│    Improve      │───────────────┘
└─────────────────┘
```

### 1. 初始翻译

第一次翻译生成时包含：
- 完整的术语表上下文
- 文档结构信息
- 前一个分块的上下文（用于连贯性）

### 2. 质量评估

每个翻译根据四个标准进行评分：

| 标准 | 权重 | 描述 |
|-----------|--------|-------------|
| 语义准确性 | 40% | 是否传达了正确的含义？ |
| 流畅性 | 25% | 在目标语言中是否读起来自然？ |
| 术语表合规性 | 20% | 是否正确应用了所有术语表术语？ |
| 格式保留 | 15% | Markdown/HTML 结构是否保持不变？ |

### 3. 反思

如果质量低于质量阈值，LLM 会分析：
- 存在哪些具体问题
- 遗漏了哪些术语表术语
- 流畅性可以在哪里改进

### 4. 改进

根据反思反馈应用有针对性的修复，然后循环重复。

## 配置

### 质量阈值

```bash
# CLI
llm-translate file doc.md -o doc.ko.md --target ko --quality 90

# Config file
{
  "translation": {
    "qualityThreshold": 90
  }
}
```

### 最大迭代次数

```bash
# CLI
llm-translate file doc.md -o doc.ko.md --target ko --max-iterations 6

# Config file
{
  "translation": {
    "maxIterations": 6
  }
}
```

### 严格模式

如果未达到质量阈值则失败：

```bash
llm-translate file doc.md -o doc.ko.md --target ko --strict
```

退出代码：
-`0`- 成功
-`4`- 未达到质量阈值（严格模式）

## 质量分数解释

| 分数 | 质量等级 | 描述 |
|-------|--------------|-------------|
| 95-100 | 优秀 | 可发布 |
| 85-94 | 良好 | 问题轻微，大多数用途可接受 |
| 75-84 | 一般 | 问题明显，可能需要审查 |
| 60-74 | 较差 | 问题严重，需要人工审查 |
| < 60 | 不可接受 | 问题重大，考虑重新翻译 |

## 理解输出

```
✓ Translation complete
  Quality: 92/85 (threshold met)
  Breakdown:
    - Accuracy: 38/40
    - Fluency: 24/25
    - Glossary: 18/20
    - Format: 12/15
  Iterations: 2
```

### 分项分析

- **准确性 (38/40)**：翻译在语义上正确
- **流畅性 (24/25)**：在目标语言中读起来自然
- **术语表 (18/20)**：大多数术语已应用，有些变化
- **格式 (12/15)**：需要进行轻微格式调整

## 调整质量

### 提高质量

1. **提高阈值**：`--quality 95`
2. **允许更多迭代**：`--max-iterations 6`
3. **使用更好的模型**：`--model claude-sonnet-4-5-20250929`
4. **提供更多上下文**：在配置中添加文档目的

### 加快处理速度

1. **降低阈值**：`--quality 75`
2. **减少迭代次数**：`--max-iterations 2`
3. **使用更快的模型**：`--model claude-haiku-4-5-20251001`

### 成本与质量权衡

| 设置 | 成本 | 时间 | 质量 |
|---------|------|------|---------|
| threshold=70, iterations=2 | 低 | 快 | 草稿 |
| threshold=85, iterations=4 | 中等 | 中等 | 标准 |
| threshold=95, iterations=6 | 高 | 慢 | 高级 |

## 质量问题和解决方案

### 准确性分数低

**原因：**
- 源文本含糊不清
- 缺少上下文
- 复杂的技术内容

**解决方案：**
- 为术语表术语添加上下文
- 使用更强大的模型
- 将复杂句子分解为更简单的句子

### 流畅性分数低

**原因：**
- 逐字翻译
- 措辞不自然
- 语气不当（正式/非正式）

**解决方案：**
- 增加最大迭代次数
- 使用本地质量模型（Sonnet/GPT-4）
- 审查源文本的清晰度

### 术语表合规性低

**原因：**
- 术语不在术语表中
- 大小写不匹配
- 术语以不同形式出现

**解决方案：**
- 将缺失的术语添加到术语表
- 检查 `caseSensitive` 设置
- 添加术语变体

### 格式分数低

**原因：**
- 复杂的嵌套结构
- 包含注释的代码块
- 带有格式的表格

**解决方案：**
- 确保 Chunking 尊重结构
- 审查 Markdown 源代码
- 考虑预处理复杂内容
