# 品質管理

llm-translate は Self-Refine アルゴリズムを使用して、翻訳品質があなたの要件を満たしていることを確認します。

## Self-Refine の仕組み

```
┌─────────────────┐
│ Initial Translate│
└────────┬────────┘
         ▼
┌─────────────────┐
│ Evaluate Quality │◀──────────────┐
└────────┬────────┘               │
         ▼                        │
    Score >= Threshold?           │
         │                        │
    No   │   Yes                  │
         │    │                   │
         ▼    ▼                   │
┌─────────┐ ┌──────┐              │
│ Reflect │ │ Done │              │
└────┬────┘ └──────┘              │
     ▼                            │
┌─────────────────┐               │
│    Improve      │───────────────┘
└─────────────────┘
```

### 1. 初期翻訳

最初の翻訳は以下の情報を使用して生成されます：
- 完全な用語集コンテキスト
- ドキュメント構造情報
- 前のチャンクコンテキスト（連続性のため）

### 2. 品質評価

各翻訳は4つの基準でスコア化されます：

| 基準 | ウェイト | 説明 |
|-----------|--------|-------------|
| 意味的正確性 | 40% | 正しい意味を伝えていますか？ |
| 流暢性 | 25% | ターゲット言語で自然に読めますか？ |
| 用語集準拠 | 20% | すべての用語集用語が正しく適用されていますか？ |
| フォーマット保持 | 15% | Markdown/HTML構造は保持されていますか？ |

### 3. 反省

品質がしきい値を下回る場合、LLM は以下を分析します：
- 具体的にどのような問題が存在するか
- どの用語集用語が見落とされたか
- どこで流暢性を改善できるか

### 4. 改善

反省フィードバックに基づいて対象を絞った修正が適用され、サイクルが繰り返されます。

## 設定

### 品質しきい値

```bash
# CLI
llm-translate file doc.md -o doc.ko.md --target ko --quality 90

# Config file
{
  "translation": {
    "qualityThreshold": 90
  }
}
```

### 最大反復回数

```bash
# CLI
llm-translate file doc.md -o doc.ko.md --target ko --max-iterations 6

# Config file
{
  "translation": {
    "maxIterations": 6
  }
}
```

### 厳密モード

品質しきい値に達しない場合は失敗します：

```bash
llm-translate file doc.md -o doc.ko.md --target ko --strict
```

終了コード：
-`0`- 成功
-`4`- 品質しきい値に達しない（厳密モード）

## 品質スコアの解釈

| スコア | 品質レベル | 説明 |
|-------|--------------|-------------|
| 95-100 | 優秀 | 出版可能 |
| 85-94 | 良好 | 軽微な問題、ほとんどの用途で許容可能 |
| 75-84 | 良 | 顕著な問題、レビューが必要な場合がある |
| 60-74 | 不良 | 重大な問題、手動レビューが必要 |
| < 60 | 不可 | 大きな問題、再翻訳を検討してください |

## 出力の理解

```
✓ Translation complete
  Quality: 92/85 (threshold met)
  Breakdown:
    - Accuracy: 38/40
    - Fluency: 24/25
    - Glossary: 18/20
    - Format: 12/15
  Iterations: 2
```

### 詳細分析

- **正確性（38/40）**：翻訳は意味的に正確です
- **流暢性（24/25）**：ターゲット言語で自然に読めます
- **用語集（18/20）**：ほとんどの用語が適用されており、いくつかのバリエーションがあります
- **フォーマット（12/15）**：軽微なフォーマット調整が必要です

## 品質の調整

### より高い品質のために

1. **しきい値を上げる**：`--quality 95`
2. **より多くの反復を許可する**：`--max-iterations 6`
3. **より優れたモデルを使用する**：`--model claude-sonnet-4-5-20250929`
4. **より多くのコンテキストを提供する**：設定にドキュメント目的を追加します

### より高速な処理のために

1. **しきい値を下げる**：`--quality 75`
2. **反復回数を減らす**：`--max-iterations 2`
3. **より高速なモデルを使用する**：`--model claude-haiku-4-5-20251001`

### コストと品質のトレードオフ

| 設定 | コスト | 時間 | 品質 |
|---------|------|------|---------|
| threshold=70, iterations=2 | 低 | 高速 | ドラフト |
| threshold=85, iterations=4 | 中 | 中程度 | 標準 |
| threshold=95, iterations=6 | 高 | 低速 | プレミアム |

## 品質の問題と解決策

### 低い正確性スコア

**原因：**
- あいまいなソーステキスト
- コンテキストの不足
- 複雑な技術コンテンツ

**解決策：**
- 用語集用語にコンテキストを追加する
- より高性能なモデルを使用する
- 複雑な文をより単純な文に分割する

### 低い流暢性スコア

**原因：**
- 直訳
- 不自然な表現
- 間違ったレジスター（フォーマル/インフォーマル）

**解決策：**
- 最大反復回数を増やす
- ネイティブ品質のモデル（Sonnet/GPT-4）を使用する
- ソーステキストの明確性をレビューする

### 低い用語集準拠

**原因：**
- 用語集にない用語
- 大文字小文字の不一致
- 異なる形式で表示される用語

**解決策：**
- 不足している用語を用語集に追加する
-`caseSensitive` 設定を確認する
- 用語のバリエーションを追加する

### 低いフォーマットスコア

**原因：**
- 複雑にネストされた構造
- コメント付きコードブロック
- フォーマット付きテーブル

**解決策：**
- Chunking が構造を尊重していることを確認する
- Markdown ソースをレビューする
- 複雑なコンテンツの前処理を検討する
